# Micro-Stacks

- [Overview](#overview)
- [Inter-Stack Dependencies](#inter-stack-dependencies)
- [Hub and Spoke](#hub-and-spoke)
  - [AstrumU](#astrumu-hub-and-spoke)
- [CRDs](#crds)
- [Quick Start](#quick-start)


## [Overview](#overview)

This project is broken into separately managed smaller stacks managed by [lerna](https://github.com/lerna/lerna) monorepo style.

Rules of separation:

- Each micro-service or application
- Application container images may be rebuilt and published independent of infrastructure stack.
- Core, low-level infrastructure – like networks and cluster orchestrators
- One or more data tiers that are deployed and independently backed up

## [Inter-Stack Dependencies](#inter-stack-dependencies)

The way Pulumi programs communicate information for external consumption is by using stack exports.

Using stack exports we can create inter-stack dependencies and work on stack independently by knowing only specific dependencies.

![dependencies](./assets/diagrams/dependencies.svg)

generated by [`mermaid`](https://mermaid-js.github.io/), use command `yarn mmdc -i diagrams/dependencies.mmd -o diagrams/dependencies.svg`

## [Hub And Spoke Topology](#hub-and-spoke)

A hub and spoke network topology is a widely used network topology for all types of networks. This topology is also known as star topology. In this topology the main access point is connected to the internet to with a wire; like spokes on a wheel, all user devices connect to the wireless router in the center. All network traffic must go through the hub to reach other spokes in the network or to connect to an outside network. 
References:
- \[[microsoft architectures](https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/hybrid-networking/hub-spoke)\]
- \[[microsoft best practices](https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/hub-spoke-network-topology)\]
- \[[implementing hub and spoke](https://medium.com/@abhi0751/implementing-hub-and-spoke-network-topology-in-microsoft-azure-3dcb43dd4d2d)\]

![hub-spoke](https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/hybrid-networking/images/spoke-spoke-routing.png)

### Hub:
A hub and spoke network can be small with a single access point, like in your local WiFi-enabled coffee shop or at home, or it can be large enough to connect to a corporate enterprise with multiple APs. Most cellular voice networks are hub and spoke, as well; the cellular tower for a certain region is the hub, and all the mobile devices roaming through that area are the spokes. \[[ref](https://medium.com/@abhi0751/implementing-hub-and-spoke-network-topology-in-microsoft-azure-3dcb43dd4d2d)\]

### Spoke:
Hub and spoke networks are well understood by all network administrators, and their benefits are thoroughly documented. They offer a high degree of security because each device on the network is isolated from the others through the single connection to the wireless router. Other benefits include high performance, centralization, and simplicity. They’re relatively inexpensive and easy to wire and easy to fix if a component goes down. \[[ref](https://medium.com/@abhi0751/implementing-hub-and-spoke-network-topology-in-microsoft-azure-3dcb43dd4d2d)\]


### Typical uses for the hub and spoke architecture

- Many customers have workloads that are deployed in different environments. These environments include development, testing, and production. Many times, these workloads need to share services such as DNS, IDS, NTP, or AD DS. These shared services can be placed in the hub VNet. That way, each environment is deployed to a spoke to maintain isolation.
- Workloads that don’t require connectivity to each other, but require access to shared services.

### Benefits of the hub and spoke topology

A hub and spoke network topology is a way to isolate workloads while sharing common services. These services include identity and security. The hub is a VNet that acts as a central connection point to an on-premises network. The spokes are VNets that peer with the hub. Shared services are deployed in the hub, while individual workloads are deployed inside spoke networks. Here are some benefits of the hub and spoke network topology:

- Cost savings by centralizing services in a single location that can be shared by multiple workloads. These workloads include network virtual appliances and DNS servers.
- Overcome subscriptions limits by peering VNets from different subscriptions to the central hub.
- Separation of concerns between central IT (SecOps, InfraOps) and workloads (DevOps).


### How to create spoke network

[`@astrumu/pulumi-network`](packages/libs/network/src/spoke.ts) implements spoke class to make it easier to create spoke vNets and connection to hub.

```typescript
import { SpokeVirtualNetwork } from '@astrumu/pulumi-network';

export const spoke = new SpokeVirtualNetwork(
  config.appName,
  {
    resourceGroup: config.resourceGroup,
    hub: {
      resourceGroupName: config.hub.resourceGroupName,
      virtualNetwork: config.hub.vnet
    },
    addressPrefixes: ['10.1.4.0/22']
  },
  { parent: config.resourceGroup }
);
```

`Spoke` class will automatically create a vNet inside given `resourceGroup` and connect (vnet peer) with hub.

## [AstrumU Hub and Spoke Topology](#astrumu-hub-and-spoke)

Current state of AstrumU's hub and spoke topology, please update [hub-spoke.drawio](./assets/diagrams/hub-spoke.drawio) if you are making any changes to it.

![AstrumU Hub And Spoke](./assets/diagrams/hub-spoke_v10.png)

## [CRDs](#crds)

Already available CRDs generated using `crd2pulumi` (see guide for this tool [here](https://github.com/pulumi/crd2pulumi)):
- @pulumi/databricks
- @pulumi/elasticsearch
- @pulumi/istio
- @pulumi/prometheus

Feel free to add more packages and generate CRDs using this command: 
```bash 
crd2pulumi --nodejsPath=src/ all-crds.yaml --force
```

## [Quick Start](#quick-start)

- Install pulumi
    ```
    brew install pulumi
    ```

- Install project dependencies
    ```
    yarn
    ```

- Build project
    ```
    yarn build
    ```
- Take password from last pass:
    ![password](./assets/last-pass.png)

- Login with `PulumiServicePrincipal`
    ```
    az login --service-principal --username 8dac446c-b304-4627-85ad-a1c9104323fe --password ${PASSWORD_FROM_LAST_PASS} --tenant 9b62c0fc-ad42-4789-b7e9-0d9e03e1e11f​
    ```

- Up any stack, as an example, `hub`
    ```
    pulumi up --cwd packages/stacks/hub
    ```